<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weaving Answers - Interactive Data Textile</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --warp: #2a1810;
            --weft: #f4e8d8;
            --thread-gold: #d4a574;
            --thread-indigo: #3d5a80;
            --thread-rust: #c1666b;
            --thread-sage: #95a792;
        }

        body {
            font-family: 'Crimson Pro', serif;
            background: linear-gradient(135deg, #1a1410 0%, #2a1810 100%);
            color: var(--weft);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(244, 232, 216, 0.03);
            border: 1px solid rgba(244, 232, 216, 0.1);
            border-radius: 2px;
        }

        h1 {
            font-size: 3em;
            font-weight: 300;
            letter-spacing: 0.05em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--thread-gold), var(--thread-rust));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-family: 'Space Mono', monospace;
            font-size: 0.85em;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            opacity: 0.6;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .question-panel {
            background: rgba(244, 232, 216, 0.05);
            padding: 30px;
            border: 1px solid rgba(244, 232, 216, 0.15);
            border-radius: 2px;
        }

        .question-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.75em;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            opacity: 0.5;
            margin-bottom: 15px;
        }

        #currentQuestion {
            font-size: 1.8em;
            line-height: 1.4;
            margin-bottom: 30px;
            font-weight: 300;
        }

        #answerInput {
            width: 100%;
            padding: 20px;
            font-family: 'Crimson Pro', serif;
            font-size: 1.2em;
            background: rgba(244, 232, 216, 0.08);
            border: 2px solid rgba(244, 232, 216, 0.2);
            color: var(--weft);
            border-radius: 2px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        #answerInput:focus {
            outline: none;
            border-color: var(--thread-gold);
            background: rgba(244, 232, 216, 0.12);
        }

        #submitAnswer {
            width: 100%;
            padding: 18px;
            font-family: 'Space Mono', monospace;
            font-size: 0.9em;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--thread-gold), var(--thread-rust));
            border: none;
            color: var(--warp);
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        #submitAnswer:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(212, 165, 116, 0.3);
        }

        #submitAnswer:active {
            transform: translateY(0);
        }

        #exportButton {
            width: 100%;
            padding: 18px;
            font-family: 'Space Mono', monospace;
            font-size: 0.9em;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--thread-indigo), var(--thread-sage));
            border: none;
            color: var(--weft);
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.3s ease;
            font-weight: 700;
            margin-top: 15px;
        }

        #exportButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(61, 90, 128, 0.3);
        }

        #exportButton:active {
            transform: translateY(0);
        }

        .stats {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid rgba(244, 232, 216, 0.1);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-family: 'Space Mono', monospace;
            font-size: 0.85em;
        }

        .stat-label {
            opacity: 0.6;
            letter-spacing: 0.1em;
        }

        .stat-value {
            color: var(--thread-gold);
            font-weight: 700;
        }

        .weaving-canvas {
            background: rgba(244, 232, 216, 0.02);
            border: 1px solid rgba(244, 232, 216, 0.15);
            border-radius: 2px;
            padding: 20px;
            min-height: 600px;
            position: relative;
            overflow: hidden;
        }

        .pattern-title {
            font-family: 'Space Mono', monospace;
            font-size: 0.75em;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            opacity: 0.5;
            margin-bottom: 20px;
            text-align: center;
        }

        #weavingPattern {
            display: grid;
            gap: 2px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .weave-thread {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 1px;
            transition: all 0.5s ease;
            background-size: cover;
            background-position: center;
        }

        .thread-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Crimson Pro', serif;
            font-size: 0.7em;
            color: var(--weft);
            text-align: center;
            padding: 5px;
            background: linear-gradient(135deg, 
                rgba(42, 24, 16, 0.65), 
                rgba(42, 24, 16, 0.55));
            word-break: break-word;
            line-height: 1.2;
            font-weight: 400;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }

        .legend {
            margin-top: 30px;
            padding: 20px;
            background: rgba(244, 232, 216, 0.03);
            border: 1px solid rgba(244, 232, 216, 0.1);
            border-radius: 2px;
        }

        .legend-title {
            font-family: 'Space Mono', monospace;
            font-size: 0.75em;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            opacity: 0.5;
            margin-bottom: 15px;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .legend-item {
            font-size: 0.9em;
            line-height: 1.6;
        }

        .diversity-indicator {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, 
                rgba(212, 165, 116, 0.1), 
                rgba(193, 102, 107, 0.1));
            border-left: 3px solid var(--thread-gold);
            border-radius: 2px;
        }

        .diversity-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.75em;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            opacity: 0.7;
            margin-bottom: 8px;
        }

        .diversity-value {
            font-size: 1.5em;
            color: var(--thread-gold);
            font-weight: 600;
        }

        @keyframes weaveIn {
            from {
                opacity: 0;
                transform: scale(0.8) rotate(-5deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .weave-thread.new {
            animation: weaveIn 0.5s ease-out;
        }

        @media (max-width: 1000px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- html2canvas for PNG export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <div class="container">
        <header>
            <h1>Weaving Answers</h1>
            <div class="subtitle">Interactive Data Textile</div>
            <div style="margin-top: 15px; font-family: 'Space Mono', monospace; font-size: 0.8em; opacity: 0.6;">
                <span id="onlineCount">üåê Connecting...</span>
            </div>
        </header>

        <div class="main-grid">
            <div class="question-panel">
                <div class="question-label">Question</div>
                <div id="currentQuestion">Does AI make you more efficient in your work?</div>
                
                <input type="text" id="answerInput" placeholder="Type your answer here..." autocomplete="off">
                <button id="submitAnswer">Weave Answer</button>
                <button id="exportButton">üì∏ Export Textile as PNG</button>

                <div class="stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Threads</span>
                        <span class="stat-value" id="totalThreads">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Unique Answers</span>
                        <span class="stat-value" id="uniqueAnswers">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Pattern Density</span>
                        <span class="stat-value" id="patternDensity">0%</span>
                    </div>
                </div>

                <div class="diversity-indicator">
                    <div class="diversity-label">Diversity Score</div>
                    <div class="diversity-value" id="diversityScore">0.00</div>
                </div>
            </div>

            <div class="weaving-canvas">
                <div class="pattern-title">Your Collective Weave</div>
                <div id="weavingPattern"></div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-title">Pattern Guide</div>
            <div class="legend-items">
                <div class="legend-item">
                    <strong>Thread Size:</strong> Determined by answer diversity - unique answers create larger data points
                </div>
                <div class="legend-item">
                    <strong>Placement:</strong> Random images (image01.png - image100.png) form the textile base
                </div>
                <div class="legend-item">
                    <strong>Pattern Type:</strong> Adapts between jacquard, plaid, herringbone, and twill based on diversity
                </div>
                <div class="legend-item">
                    <strong>Text:</strong> Each answer is woven into the textile and visible on every thread
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAv7mCzyFnVE_pvLQyZsDacdqJo387oCts",
            authDomain: "weavingdiversedata.firebaseapp.com",
            projectId: "weavingdiversedata",
            storageBucket: "weavingdiversedata.firebasestorage.app",
            messagingSenderId: "331704605325",
            appId: "1:331704605325:web:69b17c5590bc12e8c7a0c4",
            measurementId: "G-R81YTMZ608"
        };

        // Initialize Firebase
        let db, answersCollection, onlineCollection, myPresenceDoc;
        let isOnline = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            answersCollection = db.collection('weavingAnswers');
            onlineCollection = db.collection('weavingOnline');
            isOnline = true;
            console.log('‚úÖ Firestore connected');
        } catch (error) {
            console.log('üì¥ Running in offline mode:', error);
            isOnline = false;
        }

        // Presence tracking with Firestore
        if (isOnline) {
            // Create a unique presence document for this user
            myPresenceDoc = onlineCollection.doc();
            
            // Set presence
            myPresenceDoc.set({
                online: true,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Clean up on disconnect (using visibility API as fallback)
            const cleanup = () => {
                if (myPresenceDoc) {
                    myPresenceDoc.delete().catch(() => {});
                }
            };
            
            window.addEventListener('beforeunload', cleanup);
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) cleanup();
            });

            // Update online count
            onlineCollection.onSnapshot((snapshot) => {
                const count = snapshot.size;
                document.getElementById('onlineCount').textContent = `üë• ${count} weaving now`;
            });

            // Clean up old presence records (older than 5 minutes)
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
            onlineCollection.where('timestamp', '<', fiveMinutesAgo).get().then((snapshot) => {
                snapshot.forEach((doc) => doc.ref.delete());
            });
        } else {
            document.getElementById('onlineCount').textContent = 'üì¥ Offline mode';
        }

        // Configuration
        const TOTAL_IMAGES = 20;
        const questions = [
            "Does AI make you more efficient in your work?",
            "Can AI perform the tasks that you need completed in your life?",
            "Would a self-driving car help you?",
            "Does technology improve your learning?",
            "Do you feel in control of the technology you use daily?",
            "Does social media give you power or take it away?",
            "Can you customize your digital tools to fit your needs?",
            "Do algorithms serve you or manipulate you?",
            "Does automation free you or replace you?",
            "Do you trust AI to make decisions that affect your life?"
        ];

        // State
        let answers = [];
        let currentQuestionIndex = 0;
        let threadCount = 0;

        // DOM Elements
        const questionEl = document.getElementById('currentQuestion');
        const answerInput = document.getElementById('answerInput');
        const submitBtn = document.getElementById('submitAnswer');
        const weavingPattern = document.getElementById('weavingPattern');
        const totalThreadsEl = document.getElementById('totalThreads');
        const uniqueAnswersEl = document.getElementById('uniqueAnswers');
        const patternDensityEl = document.getElementById('patternDensity');
        const diversityScoreEl = document.getElementById('diversityScore');

        // Listen for Firestore updates
        if (isOnline) {
            answersCollection.orderBy('timestamp', 'asc').onSnapshot((snapshot) => {
                answers = [];
                snapshot.forEach((doc) => {
                    answers.push(doc.data().answer);
                });
                updateWeaving();
            });
        }

        // Calculate diversity score (higher = more varied answers)
        function calculateDiversity() {
            if (answers.length === 0) return 0;
            
            const uniqueAnswers = new Set(answers.map(a => a.toLowerCase().trim()));
            const diversityRatio = uniqueAnswers.size / answers.length;
            
            // Bonus for length variety
            const lengths = answers.map(a => a.length);
            const avgLength = lengths.reduce((a, b) => a + b, 0) / lengths.length;
            const lengthVariance = lengths.reduce((sum, len) => sum + Math.pow(len - avgLength, 2), 0) / lengths.length;
            const lengthDiversity = Math.min(lengthVariance / 100, 1);
            
            return (diversityRatio * 0.7 + lengthDiversity * 0.3).toFixed(2);
        }

        // Get weaving pattern type based on diversity
        function getPatternType(diversity) {
            if (diversity > 0.8) return 'jacquard';
            if (diversity > 0.6) return 'herringbone';
            if (diversity > 0.4) return 'twill';
            return 'plaid';
        }

        // Get grid columns based on pattern and thread count
        function getGridColumns(patternType, count) {
            if (count <= 4) return 2;
            if (count <= 9) return 3;
            if (count <= 16) return 4;
            if (count <= 25) return 5;
            if (patternType === 'jacquard') return Math.min(8, Math.ceil(Math.sqrt(count)));
            if (patternType === 'herringbone') return Math.min(7, Math.ceil(Math.sqrt(count)));
            if (patternType === 'twill') return Math.min(6, Math.ceil(Math.sqrt(count)));
            return Math.min(5, Math.ceil(Math.sqrt(count)));
        }

        // Get random image
        function getRandomImage() {
            const imageNum = Math.floor(Math.random() * TOTAL_IMAGES) + 1;
            const paddedNum = String(imageNum).padStart(2, '0');
            return `images/image${paddedNum}.png`;
        }

        // Calculate thread size based on answer uniqueness
        function getThreadSize(answer) {
            const normalizedAnswer = answer.toLowerCase().trim();
            const occurrences = answers.filter(a => a.toLowerCase().trim() === normalizedAnswer).length;
            
            // More unique = larger thread
            if (occurrences === 1) return 1.5; // Very unique
            if (occurrences === 2) return 1.2;
            if (occurrences === 3) return 1.0;
            return 0.8; // Common answer = smaller
        }

        // Update the weaving pattern
        function updateWeaving() {
            const diversity = calculateDiversity();
            const patternType = getPatternType(diversity);
            const columns = getGridColumns(patternType, answers.length);
            
            weavingPattern.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
            
            // Clear and rebuild
            weavingPattern.innerHTML = '';
            
            answers.forEach((answer, index) => {
                const thread = document.createElement('div');
                thread.className = 'weave-thread new';
                
                // Random image background
                const imagePath = getRandomImage();
                thread.style.backgroundImage = `url('${imagePath}')`;
                
                // Size based on uniqueness
                const size = getThreadSize(answer);
                thread.style.transform = `scale(${size})`;
                thread.style.zIndex = Math.floor(size * 10);
                
                // Answer overlay
                const overlay = document.createElement('div');
                overlay.className = 'thread-overlay';
                overlay.textContent = answer;
                thread.appendChild(overlay);
                
                weavingPattern.appendChild(thread);
                
                // Remove 'new' class after animation
                setTimeout(() => thread.classList.remove('new'), 500);
            });
            
            // Update stats
            totalThreadsEl.textContent = answers.length;
            uniqueAnswersEl.textContent = new Set(answers.map(a => a.toLowerCase().trim())).size;
            patternDensityEl.textContent = Math.min(100, Math.round(answers.length * 2.5)) + '%';
            diversityScoreEl.textContent = diversity;
        }

        // Submit answer
        function submitAnswer() {
            const answer = answerInput.value.trim();
            
            if (!answer) {
                answerInput.style.borderColor = 'var(--thread-rust)';
                setTimeout(() => {
                    answerInput.style.borderColor = 'rgba(244, 232, 216, 0.2)';
                }, 300);
                return;
            }
            
            if (isOnline) {
                // Add to Firestore
                answersCollection.add({
                    answer: answer,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    console.log('Answer added to Firestore');
                }).catch((error) => {
                    console.error('Error adding answer:', error);
                });
            } else {
                // Add locally
                answers.push(answer);
                updateWeaving();
            }
            
            threadCount++;
            
            // Clear input
            answerInput.value = '';
            answerInput.focus();
            
            // Cycle questions
            currentQuestionIndex = (currentQuestionIndex + 1) % questions.length;
            questionEl.textContent = questions[currentQuestionIndex];
        }

        // Export textile as PNG
        async function exportTextile() {
            const exportBtn = document.getElementById('exportButton');
            const originalText = exportBtn.textContent;
            
            try {
                exportBtn.textContent = '‚è≥ Capturing textile...';
                exportBtn.disabled = true;
                
                // Wait a moment for any images to finish loading
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const canvas = await html2canvas(document.querySelector('.weaving-canvas'), {
                    backgroundColor: 'rgba(42, 24, 16, 1)',
                    scale: 4, // Much higher quality (4x resolution)
                    logging: true, // Enable logging to see what's happening
                    useCORS: true, // Allow cross-origin images
                    allowTaint: true, // Allow tainted canvas
                    foreignObjectRendering: false, // Disable foreign object rendering
                    imageTimeout: 15000, // Wait up to 15 seconds for images
                    removeContainer: true,
                    width: document.querySelector('.weaving-canvas').offsetWidth,
                    height: document.querySelector('.weaving-canvas').offsetHeight,
                    windowWidth: document.querySelector('.weaving-canvas').scrollWidth,
                    windowHeight: document.querySelector('.weaving-canvas').scrollHeight
                });
                
                // Convert to PNG and download
                canvas.toBlob((blob) => {
                    if (!blob) {
                        throw new Error('Failed to create image blob');
                    }
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    link.download = `weaving-textile-${timestamp}.png`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    exportBtn.textContent = '‚úÖ Exported!';
                    setTimeout(() => {
                        exportBtn.textContent = originalText;
                        exportBtn.disabled = false;
                    }, 2000);
                }, 'image/png');
                
            } catch (error) {
                console.error('Export error details:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                exportBtn.textContent = '‚ùå Export failed - check console';
                setTimeout(() => {
                    exportBtn.textContent = originalText;
                    exportBtn.disabled = false;
                }, 3000);
                
                // Show user-friendly error
                alert('Export failed. Common fixes:\n\n1. Make sure all images are in the images/ folder\n2. Run from a web server (not file://)\n3. Check browser console (F12) for details');
            }
        }

        // Event listeners
        submitBtn.addEventListener('click', submitAnswer);
        document.getElementById('exportButton').addEventListener('click', exportTextile);
        answerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitAnswer();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (isOnline && myPresenceDoc) {
                myPresenceDoc.delete().catch(() => {});
            }
        });

        // Initialize
        answerInput.focus();
    </script>
</body>
</html>
